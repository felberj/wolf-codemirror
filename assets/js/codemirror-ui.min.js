/* Demonstration of embedding CodeMirror in a bigger application. The
* interface defined here is a mess of prompts and confirms, and
* should probably not be used in a real project.
*///var CodeMirrorUI = Class.create();
function CodeMirrorUI(place,options,mirrorOptions){this.initialize(place,options,mirrorOptions)}CodeMirrorUI.prototype={initialize:function(textarea,options,mirrorOptions){var defaultOptions={searchMode:"popup",path:"js",buttons:["search","undo","redo","jump","reindentSelection","reindent","about"]};this.textarea=textarea,this.options=options,this.setDefaults(this.options,defaultOptions),this.buttonDefs={search:["Search/Replace","find_replace_popup",this.options.path+"../images/silk/find.png",this.find_replace_popup],searchClose:["Close","find_replace_popup_close",this.options.path+"../images/silk/cancel.png",this.find_replace_popup_close],searchDialog:["Search/Replace","find_replace_window",this.options.path+"../images/silk/find.png",this.find_replace_window],undo:["Undo","undo",this.options.path+"../images/silk/arrow_undo.png",this.undo],redo:["Redo","redo",this.options.path+"../images/silk/arrow_redo.png",this.redo],jump:["Jump to line #","jump",this.options.path+"../images/silk/page_go.png",this.jump],reindentSelection:["Reformat selection","reindentSelect",this.options.path+"../images/silk/text_indent.png",this.reindentSelection],reindent:["Reformat whole document","reindent",this.options.path+"../images/silk/page_refresh.png",this.reindent],about:["About CodeMirror-UI","about",this.options.path+"../images/silk/help.png",this.about]},this.home=document.createElement("div"),this.textarea.parentNode.insertBefore(this.home,this.textarea),this.self=this;var onChange=this.editorChanged.bind(this);mirrorOptions.onChange?mirrorOptions.onChange=function(){mirrorOptions.onChange(),onChange()}:mirrorOptions.onChange=onChange,mir=CodeMirror.fromTextArea(this.textarea,mirrorOptions),this.mirror=mir,this.initButtons(),this.options.searchMode=="inline"?this.initFindControl():this.options.searchMode=="popup"&&this.initPopupFindControl(),this.undoButton&&this.addClass(this.undoButton,"inactive"),this.redoButton&&this.addClass(this.redoButton,"inactive")},setDefaults:function(object,defaults){for(var option in defaults)object.hasOwnProperty(option)||(object[option]=defaults[option])},toTextArea:function(){this.home.parentNode.removeChild(this.home),this.mirror.toTextArea()},initButtons:function(){this.buttonFrame=document.createElement("div"),this.buttonFrame.className="codemirror-ui-clearfix codemirror-ui-button-frame",this.home.appendChild(this.buttonFrame);for(var i=0;i<this.options.buttons.length;i++){var buttonId=this.options.buttons[i],buttonDef=this.buttonDefs[buttonId];this.addButton(buttonDef[0],buttonDef[1],buttonDef[2],buttonDef[3],this.buttonFrame)}},createFindBar:function(){var findBar=document.createElement("div");findBar.className="codemirror-ui-find-bar",this.findString=document.createElement("input"),this.findString.type="text",this.findString.size=8,this.findButton=document.createElement("input"),this.findButton.type="button",this.findButton.value="Find",this.findButton.onclick=function(){this.find()}.bind(this),this.connect(this.findString,"keyup",function(e){var code=e.keyCode;code==13?this.find(this.mirror.getCursor(!1)):!this.findString.value==""&&this.find(this.mirror.getCursor(!0)),this.findString.focus()}.bind(this));var regLabel=document.createElement("label");regLabel.title="Regular Expressions",this.regex=document.createElement("input"),this.regex.type="checkbox",this.regex.className="codemirror-ui-checkbox",regLabel.appendChild(this.regex),regLabel.appendChild(document.createTextNode("RegEx"));var caseLabel=document.createElement("label");caseLabel.title="Case Sensitive",this.caseSensitive=document.createElement("input"),this.caseSensitive.type="checkbox",this.caseSensitive.className="codemirror-ui-checkbox",caseLabel.appendChild(this.caseSensitive),caseLabel.appendChild(document.createTextNode("A/a")),this.replaceString=document.createElement("input"),this.replaceString.type="text",this.replaceString.size=8,this.connect(this.replaceString,"keyup",function(e){var code=e.keyCode;code==13&&this.replace()}.bind(this)),this.replaceButton=document.createElement("input"),this.replaceButton.type="button",this.replaceButton.value="Replace",this.replaceButton.onclick=this.replace.bind(this);var replaceAllLabel=document.createElement("label");return replaceAllLabel.title="Replace All",this.replaceAll=document.createElement("input"),this.replaceAll.type="checkbox",this.replaceAll.className="codemirror-ui-checkbox",replaceAllLabel.appendChild(this.replaceAll),replaceAllLabel.appendChild(document.createTextNode("All")),findBar.appendChild(this.findString),findBar.appendChild(this.findButton),findBar.appendChild(caseLabel),findBar.appendChild(regLabel),findBar.appendChild(this.replaceString),findBar.appendChild(this.replaceButton),findBar.appendChild(replaceAllLabel),findBar},initPopupFindControl:function(){var findBar=this.createFindBar();this.popupFindWrap=document.createElement("div"),this.popupFindWrap.className="codemirror-ui-popup-find-wrap",this.popupFindWrap.appendChild(findBar);var buttonDef=this.buttonDefs.searchClose;this.addButton(buttonDef[0],buttonDef[1],buttonDef[2],buttonDef[3],this.popupFindWrap),this.buttonFrame.appendChild(this.popupFindWrap)},initFindControl:function(){var findBar=this.createFindBar();this.buttonFrame.appendChild(findBar)},find:function(start){start==null&&(start=this.mirror.getCursor());var findString=this.findString.value;if(findString==null||findString==""){alert("You must enter something to search for.");return}this.regex.checked&&(findString=new RegExp(findString)),this.cursor=this.mirror.getSearchCursor(findString,start,!this.caseSensitive.checked);var found=this.cursor.findNext();found?this.mirror.setSelection(this.cursor.from(),this.cursor.to()):confirm("No more matches.  Should we start from the top?")&&(this.cursor=this.mirror.getSearchCursor(findString,0,!this.caseSensitive.checked),found=this.cursor.findNext(),found?this.mirror.setSelection(this.cursor.from(),this.cursor.to()):alert("No matches found."))},replace:function(){if(this.replaceAll.checked){var cursor=this.mirror.getSearchCursor(this.findString.value,this.mirror.getCursor(),!this.caseSensitive.checked);while(cursor.findNext())this.mirror.replaceRange(this.replaceString.value,cursor.from(),cursor.to())}else this.mirror.replaceRange(this.replaceString.value,this.cursor.from(),this.cursor.to()),this.find()},initWordWrapControl:function(){var wrapDiv=document.createElement("div");wrapDiv.className="codemirror-ui-wrap";var label=document.createElement("label");this.wordWrap=document.createElement("input"),this.wordWrap.type="checkbox",this.wordWrap.checked=!0,label.appendChild(this.wordWrap),label.appendChild(document.createTextNode("Word Wrap")),this.wordWrap.onchange=this.toggleWordWrap.bind(this),wrapDiv.appendChild(label),this.buttonFrame.appendChild(wrapDiv)},toggleWordWrap:function(){this.wordWrap.checked?this.mirror.setTextWrapping("nowrap"):this.mirror.setTextWrapping("")},addButton:function(name,action,image,func,frame){var button=document.createElement("a");button.className="codemirror-ui-button "+action,button.title=name,button.func=func.bind(this),button.onclick=function(event){return event.target.func(),!1}.bind(this,func);var img=document.createElement("img");img.src=image,img.border=0,img.func=func.bind(this),button.appendChild(img),frame.appendChild(button),action=="undo"&&(this.undoButton=button),action=="redo"&&(this.redoButton=button)},classNameRegex:function(className){var regex=new RegExp("(.*) *"+className+" *(.*)");return regex},addClass:function(element,className){element.className.match(this.classNameRegex(className))||(element.className+=" "+className)},removeClass:function(element,className){var m=element.className.match(this.classNameRegex(className));m&&(element.className=m[1]+" "+m[2])},editorChanged:function(){if(!this.mirror)return;var his=this.mirror.historySize();his.undo>0?this.removeClass(this.undoButton,"inactive"):this.addClass(this.undoButton,"inactive"),his.redo>0?this.removeClass(this.redoButton,"inactive"):this.addClass(this.redoButton,"inactive")},undo:function(){this.mirror.undo()},redo:function(){this.mirror.redo()},replaceSelection:function(newVal){this.mirror.replaceSelection(newVal),this.searchWindow.focus()},raise_search_window:function(){this.searchWindow.focus()},find_replace_window:function(){this.searchWindow==null&&(this.searchWindow=window.open(this.options.path+"find_replace.html","mywindow","scrollbars=1,width=400,height=350,modal=yes"),this.searchWindow.codeMirrorUI=this),this.searchWindow.focus()},find_replace_popup:function(){this.popupFindWrap.className="codemirror-ui-popup-find-wrap active",this.findString.focus()},find_replace_popup_close:function(){this.popupFindWrap.className="codemirror-ui-popup-find-wrap"},jump:function(){var line=prompt("Jump to line:","");line&&!isNaN(Number(line))&&(this.mirror.setCursor(Number(line),0),this.mirror.setSelection({line:Number(line),ch:0},{line:Number(line)+1,ch:0}),this.mirror.focus())},reindent:function(){var lineCount=this.mirror.lineCount();for(var line=0;line<lineCount;line++)this.mirror.indentLine(line)},about:function(){string="CodeMirror-UI was written by Jeremy Green (http://www.octolabs.com/) as a light interface around CodeMirror by Marijn Haverbeke (http://codemirror.net).",string+="\n\n",string+="Documentation and the code can be found at https://github.com/jagthedrummer/codemirror-ui/.",alert(string)},reindentSelection:function(){var cur=this.mirror.getCursor(),start=this.mirror.getCursor(!0).line,end=this.mirror.getCursor(!1).line;for(var line=start;line<=end;line++)this.mirror.indentLine(line)},connect:function(node,type,handler,disconnect){if(typeof node.addEventListener=="function"){node.addEventListener(type,handler,!1);if(disconnect)return function(){node.removeEventListener(type,handler,!1)}}else{node.attachEvent("on"+type,handler);if(disconnect)return function(){node.detachEvent("on"+type,handler)}}}},Function.prototype.bind=function(scope){var _function=this;return function(){return _function.apply(scope,arguments)}};